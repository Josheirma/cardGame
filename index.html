<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="style.css">
</head>
<body onunload="deleteArray()">
    <!-- 4/18/25: Charlie and BJ working on both player rows.
         Note: Dealer cannot get blackjack or 5-card charlie. -->
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>

    <div id="alternateContainer"></div>
    <div id="forFlex">
        <div id="container">
            <div id="headerContainer">
                <div id="title">BLACKJACK 5 card dealer</div>
                <div id="scoreAtTop">10</div>
            </div>

            <canvas id="canvasDealer" width="500" height="78"></canvas>
            <div>
                <canvas id="canvasPlayerTopCards" width="500" height="78"></canvas>
                <br>
                <div id="interfaceTopRow">
                    <div id="messageUnderTopRow"></div>
                    <div id="containsUpperButtons">
                        <input id="drawCardBtnUpper" type="button" value="Draw Card" onclick="drawPlayerCardTop()">
                        <input id="dealCardsBtn" type="button" value="Deal" onclick="drawDealerCards()">
                        <input id="newRoundBtn" type="button" value="New Round" onclick="newRound()">
                        <input class="wager_button" id="wagerButtonOne" type="button" value="Wager 1" onclick="wager(1)">
                        <input class="wager_button" id="wagerButtonFive" type="button" value="Wager 5" onclick="wager(5)">
                        <input class="wager_button" id="wagerButtonFifteen" type="button" value="Wager 15" onclick="wager(15)">
                        <input class="wager_button" id="wagerButtonTwentyfive" type="button" value="Wager 25" onclick="wager(25)">
                        <br><br>
                    </div>
                </div>
            </div>

            <canvas id="canvasPlayerBottomCards" width="500" height="78"></canvas>
            <div id="messageLower"></div>
            <br>
            <input id="drawCardBtnLower" type="button" value="Draw Card" onclick="drawPlayerCardBottom('0')">
            <input id="divide" type="button" value="Divide Hand" onclick="onDivideHand()">
        </div>
    </div>

    <script>
const AMOUNT_OF_STARTING_POINTS = 10;
// Space between each card displayed
const CARDGAP = 70;
// Total cards in use (4 full decks)
const AMTOFCARDS = (52 * 4);

// Set up canvas elements
let canvasDealer = document.getElementById("canvasDealer");
let canvasPlayerTopCards = document.getElementById("canvasPlayerTopCards");
let canvasPlayerBottomCards = document.getElementById("canvasPlayerBottomCards");

canvasPlayerBottomCards.style.visibility = 'hidden';
messageLower = 'hidden';
drawCardBtnLower.disabled = true;
divide.disabled = true;

let multiplierRow1 = -1;
// Starting horizontal offset for card placement
const INITIALROW = 84;

let dealerHandTotal = 0;
let isAllDelt = false;
let playerScoreTopRow = 0;
let playerScoreBottomRow = 0;
let FirstDealIsDoneFlag = false;
let SecondDealIsDoneFlag = false;

// Tracks if each dealt card is an ace
let AreThereAcesArrayRow = Array(20).fill("no ace");

let counterOfPressedDealerDrawBtn = 0;
// Drawing context for dealer row
let ctx1 = canvasDealer.getContext("2d");
let totalAllCardsPlayedBeforeShuffle = 0;

async function drawDealerCards() {
    // Prevent dealer from drawing if both hands are completed
    if (FirstDealIsDoneFlag == true && SecondDealIsDoneFlag == true) {
        return (-1);
    }

    dealCardsBtn.disabled = true;
    drawCardBtnUpper.disabled = true;
    drawCardBtnLower.disabled = true;
    newRoundBtn.disabled = false;

    let counter = 0;

    // Dealer hits until reaching 17 or 5 cards
    while (dealerHandTotal < 17) {
        totalAllCardsPlayedBeforeShuffle++;
        counterOfPressedDealerDrawBtn++;
        counter++;
        if (counter == 6) break;

        multiplierRow1++;
        let mark = getMarkOfCard();

        // Face cards count as 10
        if (mark == "Q" || mark == "K" || mark == "J" || mark == "10") {
            mark = "10";
            dealerHandTotal += 10;
        }
        // Ace counts as 1 for dealer
        else if (mark == "A") {
            dealerHandTotal += 1;
        }
        // Number cards 2â€“9
        else {
            console.log("mark", mark);
            dealerHandTotal += parseInt(mark);
        }

        console.log("dealerHandTotal", dealerHandTotal);
        ctx1.fillStyle = 'red';
        ctx1.rect((INITIALROW) + multiplierRow1 * CARDGAP, 7, 50, 64);
        ctx1.stroke();
        ctx1.font = "50px Arial";

        // Adjust position for '10', since it's wider
        if (mark == "10") {
            ctx1.fillText(mark, INITIALROW + (multiplierRow1 * CARDGAP) - 5, 57);
        } else {
            ctx1.fillText(mark, INITIALROW + (multiplierRow1 * CARDGAP) + 11, 57);
        }

        newRoundBtn.disabled = true;
        await new Promise(pause => setTimeout(pause, 1000));
        newRoundBtn.disabled = false;
    }

    // Finish dealer logic
    checkFirstHandWithDealer();
    checkSecondHandWithDealer();

    isAllDelt = true;
    multiplierRow1 = -1;
    dealerHandTotal = 0;
    dealCardsBtn.disabled = true;
}

// Game state setup
let pointsHave = AMOUNT_OF_STARTING_POINTS;
let pointsWagered = 0;
let multiplierTopRow = -1;
let counterAcesRow = -1;
let numberOfCardsDeltTopRow = 0;
let isThereASecondDeal = false;

// Alternate value to count Charlie hand (aces = 1)
let alternateHandForCharlieTopRow = 0;

let counterOfPressedUpperDrawBtn = 0;
let ctx2 = canvasPlayerTopCards.getContext("2d");

let tenCounter = 0;
let IsADivideFlag = false;

function drawPlayerCardTop() {
    SetAllWagerButtonsToDisabled(true);
    totalAllCardsPlayedBeforeShuffle++;

    counterOfPressedUpperDrawBtn++;
    divide.disabled = true;
    multiplierTopRow++;
    mark = getMarkOfCard();

    // Draw the card on canvas
    ctx2.beginPath();
    ctx2.fillStyle = 'blue';
    ctx2.rect((INITIALROW) + (multiplierTopRow * CARDGAP), 7, 50, 64);
    ctx2.stroke();
    ctx2.font = "50px Arial";

    // Remove 10 from Charlie tracker if this was a split hand
    if (IsADivideFlag) {
        alternateHandForCharlieTopRow -= 10;
        IsADivideFlag = false;
    }

    if (mark == "Q" || mark == "K" || mark == "J" || mark == "10") {
        mark = "10";
        numberOfCardsDeltTopRow++;
        if (numberOfCardsDeltTopRow <= 2) tenCounter++;

        playerScoreTopRow += 10;
        alternateHandForCharlieTopRow += 10;
    } else if (mark == "A") {
        numberOfCardsDeltTopRow++;
        counterAcesRow++;
        playerScoreTopRow += 11;
        AreThereAcesArrayRow[counterAcesRow] = "is top row ace";
        alternateHandForCharlieTopRow += 1;
    } else {
        playerScoreTopRow += parseInt(mark);
        numberOfCardsDeltTopRow++;
        alternateHandForCharlieTopRow += parseInt(mark);
    }

    // Enable divide button if exactly two tens and enough points
    if ((tenCounter == 2) && (pointsHave < (pointsWagered * 2))) {
        tenCounter = 0;
        divide.disabled = true;
    } else if (tenCounter == 2) {
        dealCardsBtn.disabled = false;
        numberOfCardsDeltTopRow--;
        divide.disabled = false;
        tenCounter = 0;
    } else {
        divide.disabled = true;
    }

    if (numberOfCardsDeltTopRow == 2 && numberOfCardsDeltBottomRow == 0) {
        dealCardsBtn.disabled = false;
    } else if (numberOfCardsDeltTopRow > 1 && numberOfCardsDeltBottomRow > 1) {
        dealCardsBtn.disabled = false;
    }

    checkPlayerTopRowForCompleteness();

    if (mark == "10") {
        ctx2.fillText(mark, (INITIALROW) + (multiplierTopRow * CARDGAP) - 5, 57);
    } else {
        ctx2.fillText(mark, INITIALROW + (multiplierTopRow * CARDGAP) + 11, 57);
    }
}


///////////////////240

// On start, disable game action buttons (wager buttons remain enabled)
function setsUpGame() {
    newRoundBtn.disabled = true;
    drawCardBtnUpper.disabled = true;
    dealCardsBtn.disabled = true;
    drawCardBtnUpper.disabled = true;
}

// Track usage for each card across 20 decks (total of 260 cards)
deckUseage = new Array(260).fill(0);

let singleDeck = ["A", "Q", "K", "J", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
// Create a single array containing all 20 decks
let decks = Array.from({ length: 20 }, () => [...singleDeck]).flat();

let text = "BLACKJACK 5 card dealer";
document.getElementById('title').textContent = text;

// Randomly selects a remaining card from the decks
function getMarkOfCard() {
    const random = new Math.seedrandom(); 
    const index = Math.trunc(random() * 259); // Range: 0 to 258

    // Check randomly chosen index first
    if (deckUseage[index] === 0) {
        deckUseage[index] = 1;
        return decks[index];
    }

    // Search backward for the next available card
    for (let i = index - 1; i >= 0; i--) {
        if (deckUseage[i] === 0) {
            deckUseage[i] = 1;
            return decks[i];
        }
    }

    // If not found, search forward from the index
    for (let i = index + 1; i < AMTOFCARDS; i++) {
        if (deckUseage[i] === 0) {
            deckUseage[i] = 1;
            return decks[i];
        }
    }

    // No cards left to draw
    return null;
}

// Enable or disable all wager buttons based on passed boolean
function SetAllWagerButtonsToDisabled(visibleflagisdisabled) {
    const wagerButtons = document.querySelectorAll('.wager_button');
    wagerButtons.forEach(button => {
        button.disabled = visibleflagisdisabled;
    });
}

// Handle player wager logic
function wager(points_Wagered) {
    // Insufficient points to place this wager
    if (points_Wagered > pointsHave) {
        return 1;
    }

    pointsWagered = points_Wagered;
    drawCardBtnUpper.disabled = false;
    SetAllWagerButtonsToDisabled(true);
}

// Handle logic when splitting the hand
function onDivideHand() {
    IsADivideFlag = true;
    // Disable divide and set up interface for split hand
    divide.disabled = true;
    document.getElementById('canvasPlayerBottomCards').style.visibility = 'visible';
    document.getElementById('messageLower').style.visibility = 'visible';
    dealCardsBtn.disabled = true;
    drawCardBtnLower.disabled = false;
    isThereASecondDeal = true;

    // Add a 10 to the bottom hand when splitting
    drawPlayerCardBottom("10");
    multiplierTopRow--;

    // Erase second card in top hand (assumed to be a 10)
    ctx2.clearRect(INITIALROW + (CARDGAP) - 1, 0, 52, 78);
    playerScoreTopRow = playerScoreTopRow - 10;
}

// Reset game state to prepare for the next round
async function newRound() {
    if (pointsHave >= 400) {
        endGame();
        return -1;
    }

    numberOfCardsDeltTopRow = 0;
    numberOfCardsDeltBottomRow = 0;

    if (pointsHave <= 0) {
        let text = "Out of points, resetting game!";
        document.getElementById('title').textContent = text;
        newRoundBtn.disabled = true;
        await new Promise(noPoints => {
            setTimeout(noPoints, 2000);
        });
        pointsHave = AMOUNT_OF_STARTING_POINTS;
        document.getElementById('scoreAtTop').textContent = pointsHave;
    }

    // Clear all card canvas elements (card height = 64, vertical offset = 8)
    ctx1.clearRect(0, 0, 530, 72);
    ctx2.clearRect(0, 0, 530, 72);
    ctx3.clearRect(0, 0, 530, 72);

    newRoundBtn.disabled = true;

    // Clear round messages
    document.getElementById('messageLower').textContent = "";
    document.getElementById('messageUnderTopRow').textContent = "";
    SetAllWagerButtonsToDisabled(false);

    // Reset all gameplay state variables
    multiplierRow1 = -1;
    dealerHandTotal = 0;
    isAllDelt = false;
    playerScoreTopRow = 0;
    playerScoreBottomRow = 0;
    multiplierTopRow = -1;
    counterAcesRow = -1;
    isThereASecondDeal = false;
    multiplierBottomRow = -1;
    totalCardsDeltBottomRow = 0;
    numberOfIterationsBottomRow = 0;
    counterAcesRow = 0;
    FirstDealIsDoneFlag = false;
    SecondDealIsDoneFlag = false;
    alternateHandForCharlieTopRow = 0;
    alternateHandForCharlieBottomRow = 0;
    IsADivideFlag = false;
    tenCounter = 0;
    counterOfPressedUpperDrawBtn = 0;
    counterOfPressedLowerDrawBtn = 0;
    counterOfPressedDealerDrawBtn = 0;

    // Reset any aces previously marked as active
    for (let i = 0; i < 4 * 5; i++) {
        if (AreThereAcesArrayRow[i] == "is top row ace" || AreThereAcesArrayRow[i] == "is bottom row ace") {
            AreThereAcesArrayRow[i] = "used ace";
        }
    }

    // Shuffle deck if over half the cards have been used
    if (totalAllCardsPlayedBeforeShuffle >= (AMTOFCARDS / 2)) {
        shuffleTheDeck();
        totalAllCardsPlayedBeforeShuffle = 0;
    }
}





///////////401 left of here///////////////////////
// Plays a sound effect when a card is drawn or clicked
function playWave() {
    const music = new Audio('adf.wav');
    music.play();
}

// Enables or disables buttons depending on game state â€” player blackjack, bust, or five card charlie
function checkEndOfHands() {
    // If player has split (two hands to play)
    if (isThereASecondDeal) {
        // Both hands have finished playing
        if (FirstDealIsDoneFlag && SecondDealIsDoneFlag) {
            newRoundBtn.disabled = false;
            drawCardBtnLower.disabled = true;
            drawCardBtnUpper.disabled = true;
            dealCardsBtn.disabled = true;
        }
        // Top hand is finished, now play bottom hand
        else if (FirstDealIsDoneFlag) {
            drawCardBtnUpper.disabled = true;
            drawCardBtnLower.disabled = false;
        }
        // Bottom hand is finished, now play top hand
        else if (SecondDealIsDoneFlag) {
            drawCardBtnUpper.disabled = false;
            drawCardBtnLower.disabled = true;
        }
    } 
    // Only one hand was played (no split)
    else if (!isThereASecondDeal) {
        if (FirstDealIsDoneFlag == true) {
            drawCardBtnUpper.disabled = true;
            newRoundBtn.disabled = false;
            dealCardsBtn.disabled = true;
        }
    }
    SetAllWagerButtonsToDisabled(false)
}

// Resets the deck when over half the cards have been used
async function shuffleTheDeck() {
    document.getElementById('title').textContent = "Shuffling The Deck...";
    deckUseage = new Array(260).fill(0); // Reset deck usage array

    // Temporarily disable wager buttons while shuffling
    SetAllWagerButtonsToDisabled(true);
    await new Promise(resolve => setTimeout(resolve, 1500));
    SetAllWagerButtonsToDisabled(false);
}

// Triggered when player wins the game by reaching 400 points
function endGame() {
    SetAllWagerButtonsToDisabled(true);
    newRoundBtn.disabled = true;
    let text = "You have won the game!";
    document.getElementById('title').textContent = text;
    return (1);
}

// Called after dealer finishes their turn if the player has a second hand (from a split)
function checkSecondHandWithDealer() {
    // Only evaluate if second hand hasn't been checked yet and player did split
    if (SecondDealIsDoneFlag == false && isThereASecondDeal) {

        // Dealer busts
        if (dealerHandTotal > 21) {
            pointsHave = pointsHave + pointsWagered;

            let text = pointsWagered > 1
                ? `BUST!  YOU WIN ${pointsWagered} POINTS`
                : `BUST!  YOU WIN ${pointsWagered} POINT`;

            document.getElementById("messageLower").textContent = text;
            document.getElementById("scoreAtTop").textContent = pointsHave;
            SecondDealIsDoneFlag = true;
            checkEndOfHands();
        }

        // Player's hand beats dealer (but no bust)
        else if (playerScoreBottomRow > dealerHandTotal) {
            pointsHave = pointsHave + pointsWagered;

            let text = pointsWagered > 1
                ? `YOU WIN ${pointsWagered} POINTS`
                : `YOU WIN ${pointsWagered} POINT`;

            document.getElementById("messageLower").textContent = text;
            document.getElementById("scoreAtTop").textContent = pointsHave;
            SecondDealIsDoneFlag = true;
            checkEndOfHands();
        }

        // Dealer wins or ties (tie goes to dealer)
        else if (playerScoreBottomRow <= dealerHandTotal) {
            pointsHave = pointsHave - pointsWagered;

            // Prevent negative score due to multiple deductions on split
            if (pointsHave < 0) {
                pointsHave = 0;
            }

            let text = pointsWagered > 1
                ? `YOU LOSE ${pointsWagered} POINTS`
                : `YOU LOSE ${pointsWagered} POINT`;

            document.getElementById("messageLower").textContent = text;
            document.getElementById("scoreAtTop").textContent = pointsHave;
            SecondDealIsDoneFlag = true;
            checkEndOfHands();
        }
    }
    return (1);
}

////////////

// Called after dealer finishes drawing cards â€” used for resolving the first (top) hand
function checkFirstHandWithDealer() {
    // Skip if this hand was already checked
    if (FirstDealIsDoneFlag == false) {

        // Dealer busts
        if (dealerHandTotal > 21) {
            pointsHave = pointsHave + pointsWagered;

            let text = pointsWagered > 1
                ? `BUST!  YOU WIN ${pointsWagered} POINTS`
                : `BUST!  YOU WIN ${pointsWagered} POINT`;

            document.getElementById("messageUnderTopRow").textContent = text;
            document.getElementById("scoreAtTop").textContent = pointsHave;
            console.log("BUST!");
            FirstDealIsDoneFlag = true;
            checkEndOfHands();
        }

        // Dealer beats or ties player (ties go to dealer)
        else if (dealerHandTotal >= playerScoreTopRow) {
            pointsHave = pointsHave - pointsWagered;

            let text = pointsWagered > 1
                ? `YOU LOSE ${pointsWagered} POINTS`
                : `YOU LOSE ${pointsWagered} POINT`;

            document.getElementById("messageUnderTopRow").textContent = text;
            document.getElementById("scoreAtTop").textContent = pointsHave;
            FirstDealIsDoneFlag = true;
            checkEndOfHands();
        }

        // Player wins with higher score than dealer
        else if (dealerHandTotal < playerScoreTopRow) {
            pointsHave = pointsHave + pointsWagered;

            let text = pointsWagered > 1
                ? `YOU WIN ${pointsWagered} POINTS`
                : `YOU WIN ${pointsWagered} POINT`;

            document.getElementById("messageUnderTopRow").textContent = text;
            document.getElementById("scoreAtTop").textContent = pointsHave;
            console.log("BUST!");
            FirstDealIsDoneFlag = true;
            checkEndOfHands();
        }
    }
    return (1);
}

/////////////////////////640 - to here

// Evaluates top row hand after each card draw for busts, blackjack, or five-card Charlie
function checkPlayerTopRowForCompleteness() {
    // If hand is over 21 and contains an unused ace, convert the ace from 11 to 1
    if (playerScoreTopRow > 21) {
        for (let i = 0; i < AMTOFCARDS; i++) {
            if (AreThereAcesArrayRow[i] == "is top row ace") {
                AreThereAcesArrayRow[i] = "used ace";
                playerScoreTopRow = playerScoreTopRow - 10;
                break;
            }
        }
    }

    // Player busts if hand is still over 21
    if (playerScoreTopRow > 21) {
        pointsHave = pointsHave - pointsWagered;

        // Prevent negative point total after double bust
        if (pointsHave < 0) {
            pointsHave = 0;
        }

        let text = "";
        // Adjust message for singular or plural
        if (pointsWagered > 1) {
            text = `BUST!  YOU LOSE ${pointsWagered} POINTS`;
        } else {
            text = `BUST!  YOU LOSE ${pointsWagered} POINT`;
        }

        // Display bust message for top row
        document.getElementById("messageUnderTopRow").textContent = text;
        document.getElementById("scoreAtTop").textContent = pointsHave;
        console.log("BUST!");
        FirstDealIsDoneFlag = true;

        checkEndOfHands();
    }

    // Player hits 21 - blackjack
    else if (playerScoreTopRow == 21) {
        pointsHave = pointsHave + (pointsWagered * 2);
        let text = `BLACKJACK!  YOU WIN ${pointsWagered * 2} POINTS`;

        document.getElementById("messageUnderTopRow").textContent = text;
        document.getElementById("scoreAtTop").textContent = pointsHave;
        FirstDealIsDoneFlag = true;
        drawCardBtnUpper.disabled = true;

        checkEndOfHands();
    }

    // Five-card Charlie (5 cards under 21)
    else if (alternateHandForCharlieTopRow < 22 && numberOfCardsDeltTopRow == 5) {
        console.log("5 Card Charlie");
        pointsHave = pointsHave + (pointsWagered * 2);
        let text = "";

        if (pointsWagered > 1) {
            text = `5 CARDS!  YOU WIN ${pointsWagered * 2} POINTS`;
        } else {
            text = `5 CARDS!  YOU WIN ${pointsWagered * 2} POINT`;
        }

        document.getElementById("messageUnderTopRow").textContent = text;
        document.getElementById("scoreAtTop").textContent = pointsHave;
        FirstDealIsDoneFlag = true;

        checkEndOfHands();
    }

    return (1);
}


//////////////////


// Evaluates bottom row hand after each card draw for busts, blackjack, or five-card Charlie
function checkPlayerBottomRowForCompleteness() {
    // If hand is over 21 and contains an unused ace, convert the ace from 11 to 1
    if (playerScoreBottomRow > 21) {
        for (let i = 0; i < AMTOFCARDS; i++) {
            if (AreThereAcesArrayRow[i] == "is bottom row ace") {
                AreThereAcesArrayRow[i] = "used ace";
                playerScoreBottomRow = playerScoreBottomRow - 10;
                break;
            }
        }
    }

    console.log("playerScoreBottomRowa", playerScoreBottomRow);

    // Player busts
    if (playerScoreBottomRow > 21) {
        pointsHave = pointsHave - pointsWagered;

        // Prevent negative point total after double bust
        if (pointsHave < 0) {
            pointsHave = 0;
        }

        let text = "";
        if (pointsWagered > 1) {
            text = `BUST!  YOU LOSE ${pointsWagered} POINTS`;
        } else {
            text = `BUST!  YOU LOSE ${pointsWagered} POINT`;
        }

        // Display bust message for bottom row
        document.getElementById("messageLower").textContent = text;
        document.getElementById("scoreAtTop").textContent = pointsHave;
        console.log("BUST!");
        SecondDealIsDoneFlag = true;

        checkEndOfHands();
    }

    // Player hits 21 - blackjack
    else if (playerScoreBottomRow == 21) {
        pointsHave = pointsHave + (pointsWagered * 2);
        let text = `BLACKJACK!  YOU WIN ${pointsWagered * 2} POINTS`;

        document.getElementById("messageLower").textContent = text;
        document.getElementById("scoreAtTop").textContent = pointsHave;
        SecondDealIsDoneFlag = true;

        checkEndOfHands();
    }

    // Five-card Charlie (5 cards under 21)
    else if (alternateHandForCharlieBottomRow < 22 && numberOfCardsDeltBottomRow == 5) {
        console.log("5 Card Charlie");
        pointsHave = pointsHave + (pointsWagered * 2);
        let text = "";

        if (pointsWagered > 1) {
            text = `5 CARDS!  YOU WIN ${pointsWagered * 2} POINTS`;
        } else {
            text = `5 CARDS!  YOU WIN ${pointsWagered * 2} POINT`;
        }

        let text2 = `Total Points: ${pointsHave}.`;

        document.getElementById("messageLower").textContent = text;
        document.getElementById("scoreAtTop").textContent = pointsHave;
        SecondDealIsDoneFlag = true;

        checkEndOfHands();
    }
}

setsUpGame();



/////////to here


</script>
</body>
</html>